Copied from SDK repo with modifications.